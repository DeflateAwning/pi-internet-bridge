<!DOCTYPE html>
<html>
  <head>
    <title>RPI Internet Bridge</title>
    <style>
      body {
        background-color: #222222;
        color: white;
        font-family: Arial, sans-serif;
       }
     </style>
  </head>
  <body>
    <h1 id="pi-internet-bridge">pi-internet-bridge</h1>
<p>How to use your raspberry pi as a WIFI to ethernet bridge
I am making this because I ran into issues while following may other tutorials.<br>Issues like <code>dnsmasq</code> failing to start on boot.<br>If you run into issues, feel free to submit an issue to this github repo<br><em>This was last updated on October 7th, 2020</em></p>
<h4 id="why-">Why?</h4>
<p>I am using an old PC and it does not have a built in WiFi reciver so I use a wireless to ethernet bridge that plugs into the wall.<br>Since the plug has issues and constantally disconnects me from the internet, I wondered if it was possible to use my raspberry pi as the bridge.<br>It works perfectly and so far has not disconnected my PC from the internet. Finally, I can play on that Minecraft server without being disconnected every 15 minutes.</p>
<p>There are plenty of this (almost the same) tutorials everywhere (they almost seem like copies..) and following them I ran into issues. I decided, &quot;Why not rewrite it, but with what actually works, so no one has to spend a sleepless night trying to fix errors when all they wanted to do was play some multiplay Minecraft.&quot;</p>
<h2 id="what-you-ll-need">What you&#39;ll need</h2>
<ul>
<li>Raspberry pi 4B (What I used for this, but any rpi with a wifi and ethernet connection will do)</li>
<li>Ethernet cable</li>
<li>A WiFI connection</li>
</ul>
<h3 id="step-1">Step 1</h3>
<p>Connect your pi to the internet<br>ssh into your pi or connect its HDMI to a display<br>Update your raspberry pi</p>
<pre><code>sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span>
sudo apt-<span class="hljs-built_in">get</span> upgrade
</code></pre><h3 id="step-2">Step 2</h3>
<p>Install <code>dnsmasq</code></p>
<pre><code>sudo apt-<span class="hljs-keyword">get</span> install dnsmasq
</code></pre><h3 id="step-3">Step 3</h3>
<p>Configure the ethernet connection<br>You need to set a static IP. Open the <code>dhcpcd.conf</code> file</p>
<pre><code>sudo nano <span class="hljs-regexp">/etc/</span>dhcpcd.conf
</code></pre><p>In this file add</p>
<pre><code>interface eth0
static ip_address=<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span>
static routers=<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.0</span>
</code></pre><p>Save the changes (CTRL + O, then CTRL + X)</p>
<h3 id="step-4">Step 4</h3>
<p>Restart <code>dnsmasq</code></p>
<pre><code><span class="hljs-attribute">sudo service dhcpcd restart</span>
</code></pre><h3 id="step-5">Step 5</h3>
<p>Before modifying dnsmasq&#39;s config make a backup copy</p>
<pre><code>sudo mv /etc/dnsmasq<span class="hljs-selector-class">.conf</span> /etc/dnsmasq<span class="hljs-selector-class">.conf</span><span class="hljs-selector-class">.orig</span>
</code></pre><p>Next open the config file</p>
<pre><code>sudo nano <span class="hljs-regexp">/etc/</span>dnsmasq.conf
</code></pre><p>And type the following</p>
<pre><code>interface=eth0       # Use interface eth0  
<span class="hljs-section">listen</span>-address=<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.1</span>   # Specify the address to <span class="hljs-section">listen</span> on
bind-dynamic      # Bind to the interface
server=<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>       # Use Google DNS
domain-needed        # Don't forward short names
bogus-priv           # Drop the non-routed address spaces.
dhcp-range=<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.50</span>,<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.150</span>,<span class="hljs-number">12</span>h # IP range and lease time
</code></pre><p>Save and exit the editor.<br>This is where I ran into issues. All the tutorials I found use <code>bind-interfaces</code>, which after some research, I found that it was making dnsmasq start the connection before it was ready. To fix the problem, I replaced <code>bind-interfaces</code> with <code>bind-dynamic</code>.</p>
<h3 id="step-6">Step 6</h3>
<p>You now need to configure the Raspberry Piâ€™s firewall so that it will forward all traffic from the eth0 connection over to the wlan0 connection.<br>To do this, enable ipv4p IP Forwarding in the <code>sysctl.conf</code> file.</p>
<pre><code>sudo nano <span class="hljs-regexp">/etc/</span>sysctl.conf
</code></pre><p>In the file find the line that has</p>
<pre><code><span class="hljs-selector-id">#net</span><span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.ip_forward</span>=<span class="hljs-number">1</span>
</code></pre><p>and uncomment it:</p>
<pre><code>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.ip_forward</span>=<span class="hljs-number">1</span>
</code></pre><p>Save and exit the file</p>
<h3 id="step-7">Step 7</h3>
<p>You probably dont want to wait until the next reboot for the configuration to load, so run</p>
<pre><code>sudo sh -c "<span class="hljs-built_in">echo</span> <span class="hljs-number">1</span> &gt; /proc/sys/<span class="hljs-built_in">net</span>/ipv4/ip_forward"
</code></pre><h3 id="step-8">Step 8</h3>
<p>Next you need to make wlan0 and eht0 to forward traffic to each other</p>
<pre><code>sudo iptables -t nat -A POSTROUTING -o wlan0 -<span class="hljs-built_in">j</span> MASQUERADE  
sudo iptables -A FORWARD -<span class="hljs-built_in">i</span> wlan0 -o eth0 -m state --state RELATED,ESTABLISHED -<span class="hljs-built_in">j</span> ACCEPT  
sudo iptables -A FORWARD -<span class="hljs-built_in">i</span> eth0 -o wlan0 -<span class="hljs-built_in">j</span> ACCEPT
</code></pre><p>Since the iptables are flushed on every boot, you will need to save them somewhere so they are loaded back in on every boot.</p>
<pre><code>sudo <span class="hljs-keyword">sh </span>-c <span class="hljs-string">"iptables-save &gt; /etc/iptables.ipv4.nat"</span>
</code></pre><p>To make the iptables load in on every boot, first run</p>
<pre><code>sudo nano /etc/rc.<span class="hljs-keyword">local</span>
</code></pre><p>Then add the following above the <code>exit 0</code></p>
<pre><code>iptables-restore &lt; /etc/iptables<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.nat</span>
</code></pre><p>Save and exit the file</p>
<h3 id="step-9">Step 9</h3>
<p>Finally restart dnsmasq</p>
<pre><code>sudo service dnsmasq <span class="hljs-literal">start</span>
</code></pre><p>Everything should now be ready. You should have a Raspberry Pi WiFi bridge. To test if its working, plug your device into the Pi&#39;s ethernet port. If your device now has an internet connection, you set everything up successfully.</p>
<p>It is reccommended that you reboot your Pi</p>
<pre><code><span class="hljs-attribute">sudo reboot</span>
</code></pre>
  </body>
</html>
